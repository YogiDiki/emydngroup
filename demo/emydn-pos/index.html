<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emydn POS - Demo Sistem Kasir</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            #struk-print, #struk-print * { visibility: visible; }
            #struk-print { position: absolute; left: 0; top: 0; width: 80mm; }
        }
        .nav-active { background-color: #991b1b; color: white; }
        .toast {
            position: fixed; top: 100px; right: 20px; background: #10b981; color: white;
            padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 9999; animation: slideIn 0.3s ease-out; display: flex; align-items: center;
            gap: 12px; font-weight: 600;
        }
        .toast.error { background: #ef4444; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .toast.hiding { animation: slideOut 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="images/logo.png" alt="Logo" class="w-12 h-12 rounded-lg" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'">
                    <div class="w-12 h-12 bg-red-800 rounded-lg flex items-center justify-center text-white font-bold text-xl" style="display:none;">E</div>
                    <div>
                        <h1 class="text-2xl font-bold text-red-800">Emydn POS</h1>
                        <p class="text-xs text-gray-500">Demo Sistem Kasir</p>
                    </div>
                </div>
                <nav class="hidden md:flex gap-4">
                    <button onclick="showPage('kasir')" class="px-6 py-2 rounded-lg font-semibold transition-all nav-active" id="nav-kasir">üõí Kasir</button>
                    <button onclick="showPage('laporan')" class="px-6 py-2 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" id="nav-laporan">üìä Laporan</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Demo Notice -->
    <div class="bg-red-800 text-white py-3">
        <div class="container mx-auto px-4">
                <p class="font-bold mb-2">üéØ SISTEM DEMO</p>
                <p class="text-xs md:text-sm opacity-90">
                    Data yang ditampilkan hanya bersifat sementara dan tersimpan di perangkat Anda.
                    Ini adalah versi demo untuk menunjukkan cara kerja sistem kasir digital kami.
                    Butuh fitur lengkap atau custom khusus sesuai kebutuhan bisnis Anda, silakan hubungi Emydn Group.
                </p>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div class="md:hidden bg-white shadow-sm sticky top-20 z-40">
        <div class="flex">
            <button onclick="showPage('kasir')" class="flex-1 py-3 font-semibold nav-active" id="tab-kasir">üõí Kasir</button>
            <button onclick="showPage('laporan')" class="flex-1 py-3 font-semibold bg-gray-200 text-gray-700" id="tab-laporan">üìä Laporan</button>
        </div>
    </div>

    <!-- Page Kasir -->
    <div id="page-kasir" class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Menu -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h2 class="text-xl font-bold text-red-800 mb-4">Menu</h2>
                    <div class="flex gap-2 mb-4 overflow-x-auto">
                        <button onclick="filterMenu('all')" class="px-4 py-2 bg-red-800 text-white rounded-lg text-sm whitespace-nowrap" id="cat-all">Semua</button>
                        <button onclick="filterMenu('makanan')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm whitespace-nowrap" id="cat-makanan">Makanan</button>
                        <button onclick="filterMenu('minuman')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm whitespace-nowrap" id="cat-minuman">Minuman</button>
                        <button onclick="filterMenu('snack')" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm whitespace-nowrap" id="cat-snack">Snack</button>
                    </div>
                    <div id="menu-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"></div>
                </div>
            </div>

            <!-- Cart -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow-md p-4 sticky top-32">
                    <h2 class="text-xl font-bold text-red-800 mb-4">Pesanan</h2>
                    <div id="cart-items" class="space-y-2 mb-4 max-h-64 overflow-y-auto"></div>

                    <!-- Voucher -->
                    <div class="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-sm font-semibold text-gray-700">Kode Voucher</label>
                            <span class="text-xs text-green-600">üí° EMYDNPOS</span>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="voucher-input" class="flex-1 border rounded px-3 py-2 text-sm" placeholder="Masukkan kode">
                            <button onclick="applyVoucher()" class="bg-red-800 text-white px-4 py-2 rounded text-sm font-semibold hover:bg-red-900">Pakai</button>
                        </div>
                        <p class="text-xs text-gray-600 mt-2">üéÅ Diskon 10%</p>
                    </div>

                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span>Subtotal:</span>
                            <span id="subtotal">Rp 0</span>
                        </div>
                        <div class="flex justify-between text-sm" id="discount-row" style="display:none;">
                            <span>Diskon <span id="discount-label"></span>:</span>
                            <span id="discount" class="text-green-600">- Rp 0</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span>PPN 11%:</span>
                            <span id="tax">Rp 0</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold text-red-800">
                            <span>Total:</span>
                            <span id="total">Rp 0</span>
                        </div>
                    </div>

                    <div class="mt-4 space-y-2">
                        <button onclick="showPayment('tunai')" class="w-full bg-red-800 text-white py-3 rounded-lg font-semibold hover:bg-red-900">üíµ Bayar Tunai</button>
                        <button onclick="showPayment('qris')" class="w-full bg-red-800 text-white py-3 rounded-lg font-semibold hover:bg-red-900">üì± Bayar QRIS</button>
                        <button onclick="clearCart()" class="w-full bg-gray-200 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-300">Batal</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Laporan -->
    <div id="page-laporan" class="container mx-auto px-4 py-6 hidden">
        <div class="bg-white rounded-lg shadow-md p-4 md:p-6">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 class="text-xl md:text-2xl font-bold text-red-800">Laporan Penjualan</h2>
                    <p class="text-sm text-gray-600 mt-1">Data tersimpan di device Anda</p>
                </div>
                <button onclick="exportPDF()" class="bg-red-800 text-white px-4 md:px-6 py-2 md:py-3 rounded-lg font-semibold hover:bg-red-900 text-sm md:text-base">üìÑ Export PDF</button>
            </div>

            <!-- Summary -->
            <div class="mb-6">
                <h3 class="text-base md:text-lg font-bold text-red-800 mb-3">RINGKASAN</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 md:p-5 rounded-lg border-2 border-red-300">
                        <p class="text-xs md:text-sm text-red-700 font-semibold mb-1">üí∞ Total Penjualan</p>
                        <p class="text-xl md:text-2xl font-bold text-red-900" id="total-penjualan">Rp 0</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 md:p-5 rounded-lg border-2 border-red-300">
                        <p class="text-xs md:text-sm text-red-700 font-semibold mb-1">üõí Jumlah Transaksi</p>
                        <p class="text-xl md:text-2xl font-bold text-red-900" id="total-transaksi">0</p>
                    </div>
                    <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 md:p-5 rounded-lg border-2 border-red-300">
                        <p class="text-xs md:text-sm text-red-700 font-semibold mb-1">üìä Total Pajak</p>
                        <p class="text-xl md:text-2xl font-bold text-red-900" id="total-pajak">Rp 0</p>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="mb-6">
                <h3 class="text-base md:text-lg font-bold text-red-800 mb-4">üìà Grafik Penjualan</h3>
                <div class="bg-gray-50 p-4 rounded-lg border-2 border-gray-200">
                    <canvas id="salesChart" style="max-height: 300px;"></canvas>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <h3 class="text-base md:text-lg font-bold text-red-800 mb-4">üìã Detail Transaksi</h3>
                <div class="border-2 border-red-200 rounded-lg overflow-hidden">
                    <table class="w-full text-xs md:text-sm">
                        <thead class="bg-red-800 text-white">
                            <tr>
                                <th class="p-2 md:p-3 text-left">Tanggal</th>
                                <th class="p-2 md:p-3 text-left">Produk</th>
                                <th class="p-2 md:p-3 text-center">Qty</th>
                                <th class="p-2 md:p-3 text-right">Harga</th>
                                <th class="p-2 md:p-3 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="transaction-table" class="divide-y divide-gray-200 bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-red-800 mb-4" id="payment-title">Pembayaran</h3>
            <div id="payment-content"></div>
        </div>
    </div>

    <!-- Struk Print -->
    <div id="struk-print" style="display:none;"></div>

           <!-- Struk Modal -->
    <div id="struk-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold text-red-800 mb-4">Struk Pembayaran</h3>
            <div id="struk-preview" class="bg-gray-50 p-4 rounded border-2 border-gray-200 mb-4 font-mono text-sm"></div>
            <div class="flex gap-2">
                <button onclick="printStruk()" class="flex-1 bg-red-800 text-white py-2 rounded-lg font-semibold hover:bg-red-900">üñ®Ô∏è Cetak Struk</button>
                <button onclick="closeStrukModal()" class="flex-1 bg-gray-200 py-2 rounded-lg font-semibold hover:bg-gray-300">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        // Menu Data
        const menuData = {
            makanan: [
                {id: 1, name: 'Nasi Goreng Spesial', price: 25000, category: 'makanan'},
                {id: 2, name: 'Mie Goreng', price: 20000, category: 'makanan'},
                {id: 3, name: 'Nasi Ayam Bakar', price: 28000, category: 'makanan'},
                {id: 4, name: 'Soto Ayam', price: 22000, category: 'makanan'},
                {id: 5, name: 'Nasi Uduk', price: 18000, category: 'makanan'},
                {id: 6, name: 'Gado-gado', price: 20000, category: 'makanan'}
            ],
            minuman: [
                {id: 7, name: 'Es Teh Manis', price: 8000, category: 'minuman'},
                {id: 8, name: 'Es Jeruk', price: 8000, category: 'minuman'},
                {id: 9, name: 'Kopi Hitam', price: 12000, category: 'minuman'},
                {id: 10, name: 'Cappuccino', price: 18000, category: 'minuman'},
                {id: 11, name: 'Jus Alpukat', price: 15000, category: 'minuman'},
                {id: 12, name: 'Air Mineral', price: 5000, category: 'minuman'}
            ],
            snack: [
                {id: 13, name: 'Pisang Goreng', price: 10000, category: 'snack'},
                {id: 14, name: 'Kentang Goreng', price: 15000, category: 'snack'},
                {id: 15, name: 'Cireng', price: 8000, category: 'snack'},
                {id: 16, name: 'Batagor', price: 12000, category: 'snack'},
                {id: 17, name: 'Siomay', price: 12000, category: 'snack'},
                {id: 18, name: 'Kerupuk', price: 5000, category: 'snack'}
            ]
        };

        let cart = [];
        let voucherApplied = null;
        let transactions = JSON.parse(localStorage.getItem('emydn_transactions') || '[]');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderMenu();
            updateLaporan();
        });

        function renderMenu(filter = 'all') {
            const grid = document.getElementById('menu-grid');
            grid.innerHTML = '';
            
            let items = [];
            if (filter === 'all') {
                items = [...menuData.makanan, ...menuData.minuman, ...menuData.snack];
            } else {
                items = menuData[filter];
            }

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-red-50 p-4 rounded-lg border border-red-200 cursor-pointer hover:bg-red-100 transition';
                div.onclick = () => addToCart(item);
                div.innerHTML = `
                    <h3 class="font-semibold text-red-800 text-sm mb-1">${item.name}</h3>
                    <p class="text-red-600 font-bold">${formatCurrency(item.price)}</p>
                `;
                grid.appendChild(div);
            });
        }

        function filterMenu(category) {
            ['all', 'makanan', 'minuman', 'snack'].forEach(cat => {
                document.getElementById(`cat-${cat}`).className = 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm whitespace-nowrap';
            });
            document.getElementById(`cat-${category}`).className = 'px-4 py-2 bg-red-800 text-white rounded-lg text-sm whitespace-nowrap';
            renderMenu(category);
        }

        function addToCart(item) {
            const existing = cart.find(c => c.id === item.id);
            if (existing) {
                existing.qty++;
            } else {
                cart.push({...item, qty: 1});
            }
            updateCart();
        }

        function updateCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';

            if (cart.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">Belum ada pesanan</p>';
            }

            cart.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                div.innerHTML = `
                    <div class="flex-1">
                        <p class="font-semibold text-sm">${item.name}</p>
                        <p class="text-xs text-gray-600">${formatCurrency(item.price)} x ${item.qty}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="changeQty(${index}, -1)" class="bg-red-200 text-red-800 w-6 h-6 rounded">-</button>
                        <span class="font-semibold">${item.qty}</span>
                        <button onclick="changeQty(${index}, 1)" class="bg-red-800 text-white w-6 h-6 rounded">+</button>
                    </div>
                `;
                container.appendChild(div);
            });

            updateTotal();
        }

        function changeQty(index, change) {
            cart[index].qty += change;
            if (cart[index].qty <= 0) {
                cart.splice(index, 1);
            }
            updateCart();
        }

        function applyVoucher() {
            const code = document.getElementById('voucher-input').value.toUpperCase();
            if (code === 'EMYDNPOS') {
                voucherApplied = {code: 'EMYDNPOS', discount: 0.10};
                showToast('‚úÖ Voucher berhasil! Diskon 10%', 'success');
                updateTotal();
            } else if (code) {
                showToast('‚ùå Kode voucher tidak valid', 'error');
            }
        }
        
        function showToast(message, type = 'success') {
            const existingToast = document.querySelector('.toast');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'error' ? 'error' : ''}`;
            toast.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            let discount = 0;
            
            if (voucherApplied) {
                discount = Math.round(subtotal * voucherApplied.discount);
                document.getElementById('discount-row').style.display = 'flex';
                document.getElementById('discount-label').textContent = `(${voucherApplied.code})`;
                document.getElementById('discount').textContent = '- ' + formatCurrency(discount);
            } else {
                document.getElementById('discount-row').style.display = 'none';
            }

            const afterDiscount = subtotal - discount;
            const tax = Math.round(afterDiscount * 0.11);
            const total = afterDiscount + tax;

            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('tax').textContent = formatCurrency(tax);
            document.getElementById('total').textContent = formatCurrency(total);
        }

        function clearCart() {
            if (cart.length === 0) return;
            if (confirm('Batalkan pesanan?')) {
                cart = [];
                voucherApplied = null;
                document.getElementById('voucher-input').value = '';
                updateCart();
            }
        }

        function showPayment(method) {
            if (cart.length === 0) {
                showToast('‚ö†Ô∏è Keranjang kosong!', 'error');
                return;
            }

            const modal = document.getElementById('payment-modal');
            const content = document.getElementById('payment-content');
            const title = document.getElementById('payment-title');
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discount = voucherApplied ? Math.round(subtotal * voucherApplied.discount) : 0;
            const afterDiscount = subtotal - discount;
            const tax = Math.round(afterDiscount * 0.11);
            const total = afterDiscount + tax;

            if (method === 'tunai') {
                title.textContent = 'Pembayaran Tunai';
                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold mb-2">Total:</label>
                            <p class="text-2xl font-bold text-red-800">${formatCurrency(total)}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-2">Uang Diterima:</label>
                            <input type="text" id="uang-tunai" class="w-full border rounded-lg p-2" placeholder="0" oninput="formatInputCurrency(this)">
                        </div>
                        <div id="kembalian-display"></div>
                        <div class="flex gap-2">
                            <button onclick="processPayment('tunai')" class="flex-1 bg-red-800 text-white py-2 rounded-lg font-semibold">Proses</button>
                            <button onclick="closeModal()" class="flex-1 bg-gray-200 py-2 rounded-lg font-semibold">Batal</button>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('uang-tunai').addEventListener('input', (e) => {
                        const value = e.target.value.replace(/\./g, '');
                        const uang = parseInt(value || 0);
                        const kembalian = uang - total;
                        const display = document.getElementById('kembalian-display');
                        if (kembalian >= 0) {
                            display.innerHTML = `<p class="text-green-600 font-bold">Kembalian: ${formatCurrency(kembalian)}</p>`;
                        } else {
                            display.innerHTML = '<p class="text-red-600 text-sm">Uang kurang</p>';
                        }
                    });
                }, 100);
            } else {
                title.textContent = 'Pembayaran QRIS';
                content.innerHTML = `
                    <div class="space-y-4 text-center">
                        <p class="text-2xl font-bold text-red-800">${formatCurrency(total)}</p>
                        <div class="bg-gray-100 p-8 rounded-lg">
                            <div class="w-48 h-48 mx-auto bg-white flex items-center justify-center border-4 border-gray-300">
                                <p class="text-6xl">üì±</p>
                            </div>
                            <p class="mt-4 text-sm text-gray-600">Scan QRIS</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="processPayment('qris')" class="flex-1 bg-red-800 text-white py-2 rounded-lg font-semibold">Konfirmasi</button>
                            <button onclick="closeModal()" class="flex-1 bg-gray-200 py-2 rounded-lg font-semibold">Batal</button>
                        </div>
                    </div>
                `;
            }

            modal.classList.remove('hidden');
        }

        function formatInputCurrency(input) {
            let value = input.value.replace(/\D/g, '');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            input.value = value;
        }

        function closeModal() {
            document.getElementById('payment-modal').classList.add('hidden');
        }

        function processPayment(method) {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discount = voucherApplied ? Math.round(subtotal * voucherApplied.discount) : 0;
            const afterDiscount = subtotal - discount;
            const tax = Math.round(afterDiscount * 0.11);
            const total = afterDiscount + tax;

            if (method === 'tunai') {
                const uangStr = document.getElementById('uang-tunai').value.replace(/\./g, '');
                const uang = parseInt(uangStr || 0);
                if (uang < total) {
                    showToast('‚ö†Ô∏è Uang tidak cukup!', 'error');
                    return;
                }
            }

            const now = new Date();
            const transaction = {
                invoice: 'INV-' + Date.now(),
                date: now.toLocaleDateString('id-ID'),
                time: now.toLocaleTimeString('id-ID'),
                items: [...cart],
                subtotal: subtotal,
                discount: discount,
                discountLabel: voucherApplied ? voucherApplied.code : null,
                tax: tax,
                total: total,
                method: method.toUpperCase(),
                timestamp: now.getTime()
            };

            transactions.push(transaction);
            localStorage.setItem('emydn_transactions', JSON.stringify(transactions));

            showStrukModal(transaction);
            cart = [];
            voucherApplied = null;
            document.getElementById('voucher-input').value = '';
            updateCart();
            closeModal();
            updateLaporan();
            
            showToast('‚úÖ Pembayaran berhasil!', 'success');
        }

        let currentTransaction = null;

        function showStrukModal(transaction) {
            currentTransaction = transaction;
            const modal = document.getElementById('struk-modal');
            const preview = document.getElementById('struk-preview');
            
            preview.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <img src="images/logo.png" alt="Logo" style="width: 60px; height: 60px; margin: 0 auto 10px; border-radius: 8px; display: block;" onerror="this.style.display='none'">
                    <h2 style="margin: 0; font-size: 18px; font-weight: bold;">EMYDN POS</h2>
                    <p style="margin: 5px 0; font-size: 10px;">${transaction.date} ${transaction.time}</p>
                    <p style="margin: 10px 0;">============================</p>
                </div>
                <div style="font-size: 11px;">
                    ${transaction.items.map(item => `
                        <div style="margin-bottom: 8px;">
                            <div>${item.name}</div>
                            <div style="padding-left: 10px; font-size: 10px; display: flex; justify-content: space-between;">
                                <span>${item.qty} x ${formatCurrency(item.price)}</span>
                                <span>${formatCurrency(item.qty * item.price)}</span>
                            </div>
                        </div>
                    `).join('')}
                    <p style="margin: 10px 0;">============================</p>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(transaction.subtotal)}</span>
                    </div>
                    ${transaction.discount > 0 ? `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0; color: green;">
                        <span>Diskon (${transaction.discountLabel}):</span>
                        <span>- ${formatCurrency(transaction.discount)}</span>
                    </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>PPN 11%:</span>
                        <span>${formatCurrency(transaction.tax)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0 5px 0; font-weight: bold; font-size: 14px;">
                        <span>TOTAL:</span>
                        <span>${formatCurrency(transaction.total)}</span>
                    </div>
                    <p style="margin: 10px 0; text-align: center;">============================</p>
                    <p style="text-align: center; font-size: 10px; margin: 5px 0;">Terima kasih atas kunjungan Anda!</p>
                    <p style="text-align: center; font-size: 10px; margin: 5px 0;">www.emydngroup.com</p>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeStrukModal() {
            document.getElementById('struk-modal').classList.add('hidden');
            currentTransaction = null;
        }

        function printStruk() {
            if (!currentTransaction) return;
            
            const transaction = currentTransaction;
            const strukDiv = document.getElementById('struk-print');
            strukDiv.style.display = 'block';
            strukDiv.style.width = '80mm';
            strukDiv.style.fontFamily = 'monospace';
            strukDiv.style.padding = '10px';
            strukDiv.style.fontSize = '12px';
            
            strukDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 15px;">
                    <img src="images/logo.png" alt="Logo" style="width: 60px; height: 60px; margin: 0 auto 10px; border-radius: 8px; display: block;" onerror="this.style.display='none'">
                    <h2 style="margin: 0; font-size: 18px;">EMYDN POS</h2>
                    <p style="margin: 5px 0; font-size: 10px;">${transaction.date} ${transaction.time}</p>
                    <p style="margin: 10px 0;">============================</p>
                </div>
                <div style="font-size: 11px;">
                    ${transaction.items.map(item => `
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>${item.name}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding-left: 10px; font-size: 10px;">
                                <span>${item.qty} x ${formatCurrency(item.price)}</span>
                                <span>${formatCurrency(item.qty * item.price)}</span>
                            </div>
                        </div>
                    `).join('')}
                    <p style="margin: 10px 0;">============================</p>
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(transaction.subtotal)}</span>
                    </div>
                    ${transaction.discount > 0 ? `
                    <div style="display: flex; justify-content: space-between; margin: 5px 0; color: green;">
                        <span>Diskon (${transaction.discountLabel}):</span>
                        <span>- ${formatCurrency(transaction.discount)}</span>
                    </div>
                    ` : ''}
                    <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                        <span>PPN 11%:</span>
                        <span>${formatCurrency(transaction.tax)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin: 10px 0 5px 0; font-weight: bold; font-size: 14px;">
                        <span>TOTAL:</span>
                        <span>${formatCurrency(transaction.total)}</span>
                    </div>
                    <p style="margin: 10px 0; text-align: center;">============================</p>
                    <p style="text-align: center; font-size: 10px; margin: 5px 0;">Terima kasih atas kunjungan Anda!</p>
                    <p style="text-align: center; font-size: 10px; margin: 5px 0;">www.emydngroup.com</p>
                </div>
            `;
            
            setTimeout(() => {
                window.print();
                setTimeout(() => {
                    strukDiv.style.display = 'none';
                    closeStrukModal();
                }, 500);
            }, 100);
        }

        function showPage(page) {
            document.getElementById('page-kasir').classList.add('hidden');
            document.getElementById('page-laporan').classList.add('hidden');
            document.getElementById('page-' + page).classList.remove('hidden');

            document.getElementById('nav-kasir').className = 'px-6 py-2 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
            document.getElementById('nav-laporan').className = 'px-6 py-2 rounded-lg font-semibold transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
            document.getElementById('nav-' + page).className = 'px-6 py-2 rounded-lg font-semibold transition-all nav-active';

            document.getElementById('tab-kasir').className = 'flex-1 py-3 font-semibold bg-gray-200 text-gray-700';
            document.getElementById('tab-laporan').className = 'flex-1 py-3 font-semibold bg-gray-200 text-gray-700';
            document.getElementById('tab-' + page).className = 'flex-1 py-3 font-semibold nav-active';

            if (page === 'laporan') {
                updateLaporan();
            }
        }

        function updateLaporan() {
            const totalTrx = transactions.length;
            const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
            const totalTax = transactions.reduce((sum, t) => sum + t.tax, 0);

            document.getElementById('total-transaksi').textContent = totalTrx;
            document.getElementById('total-penjualan').textContent = formatCurrency(totalSales);
            document.getElementById('total-pajak').textContent = formatCurrency(totalTax);

            const tbody = document.getElementById('transaction-table');
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-6 text-center text-gray-400 bg-gray-50">üì≠ Belum ada transaksi</td></tr>';
            } else {
                let tableHTML = '';
                transactions.slice().reverse().forEach(t => {
                    t.items.forEach((item, idx) => {
                        tableHTML += `
                            <tr class="hover:bg-red-50">
                                <td class="p-2 md:p-3 ${idx === 0 ? 'font-medium' : ''}">${idx === 0 ? t.date : ''}</td>
                                <td class="p-2 md:p-3">${item.name}</td>
                                <td class="p-2 md:p-3 text-center font-semibold">${item.qty}</td>
                                <td class="p-2 md:p-3 text-right">${formatCurrency(item.price)}</td>
                                <td class="p-2 md:p-3 text-right ${idx === 0 ? 'font-bold text-red-800' : ''}">${idx === 0 ? formatCurrency(t.total) : ''}</td>
                            </tr>
                        `;
                    });
                });
                tbody.innerHTML = tableHTML;
            }

            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            if (typeof Chart === 'undefined') {
                ctx.parentElement.innerHTML = '<p class="text-center text-red-600 p-4">‚ùå Chart.js belum loaded</p>';
                return;
            }

            if (window.salesChart) {
                try { window.salesChart.destroy(); } catch (e) {}
            }

            if (transactions.length === 0) {
                window.salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min'],
                        datasets: [{
                            label: 'Penjualan',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            borderColor: '#991b1b',
                            backgroundColor: 'rgba(153, 27, 27, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            title: {
                                display: true,
                                text: 'Belum ada data - Buat transaksi dulu',
                                color: '#6b7280'
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
                return;
            }

            // Group by date
            const dailyData = {};
            transactions.forEach(t => {
                const date = t.date;
                if (!dailyData[date]) dailyData[date] = 0;
                dailyData[date] += t.total;
            });

            const labels = Object.keys(dailyData).sort();
            const data = labels.map(date => dailyData[date]);

            window.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Penjualan',
                        data: data,
                        borderColor: '#991b1b',
                        backgroundColor: 'rgba(153, 27, 27, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBackgroundColor: '#991b1b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                color: '#991b1b'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return 'Total: ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    if (value >= 1000000) return (value / 1000000).toFixed(1) + 'jt';
                                    if (value >= 1000) return (value / 1000).toFixed(0) + 'rb';
                                    return value;
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function exportPDF() {
            if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                alert('‚ùå Library PDF belum loaded. Refresh halaman dan coba lagi.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const now = new Date();
                const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
                const totalTax = transactions.reduce((sum, t) => sum + t.tax, 0);

                // Header
                doc.setFillColor(153, 27, 27);
                doc.rect(15, 10, 20, 20, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.text('E', 25, 26);

                doc.setTextColor(153, 27, 27);
                doc.setFontSize(18);
                doc.text('LAPORAN PENJUALAN', 105, 20, null, null, 'center');
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text('Dicetak: ' + now.toLocaleDateString('id-ID'), 105, 30, null, null, 'center');

                // Summary
                doc.setFillColor(254, 226, 226);
                doc.roundedRect(15, 40, 180, 25, 3, 3, 'F');
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text('Total Penjualan:', 20, 48);
                doc.text('Jumlah Transaksi:', 20, 54);
                doc.text('Total Pajak:', 20, 60);
                
                doc.setFont('helvetica', 'bold');
                doc.text(formatCurrency(totalSales), 70, 48);
                doc.text(transactions.length + ' transaksi', 70, 54);
                doc.text(formatCurrency(totalTax), 70, 60);

                // Table Header
                doc.setFillColor(153, 27, 27);
                doc.rect(15, 75, 180, 8, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(9);
                doc.text('Tanggal', 17, 80);
                doc.text('Produk', 50, 80);
                doc.text('Qty', 110, 80);
                doc.text('Harga', 135, 80);
                doc.text('Total', 175, 80);

                // Table Content
                let yPos = 88;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');

                if (transactions.length === 0) {
                    doc.setTextColor(150, 150, 150);
                    doc.text('Belum ada transaksi', 105, yPos, null, null, 'center');
                } else {
                    transactions.slice().reverse().forEach(t => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }

                        t.items.forEach((item, idx) => {
                            if (yPos > 270) {
                                doc.addPage();
                                yPos = 20;
                            }

                            if (idx === 0 && t.date) {
                                doc.setFont('helvetica', 'bold');
                                doc.text(t.date, 17, yPos);
                                doc.setFont('helvetica', 'normal');
                            }
                            
                            const productName = item.name.length > 25 ? item.name.substring(0, 22) + '...' : item.name;
                            doc.text(productName, 50, yPos);
                            doc.text(String(item.qty), 110, yPos);
                            doc.text(formatCurrency(item.price), 135, yPos);
                            
                            if (idx === 0) {
                                doc.setFont('helvetica', 'bold');
                                doc.text(formatCurrency(t.total), 175, yPos);
                                doc.setFont('helvetica', 'normal');
                            }
                            
                            yPos += 6;
                        });
                        
                        yPos += 2;
                    });
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Emydn POS', 105, 285, null, null, 'center');
                    doc.text('Hal ' + i + '/' + pageCount, 105, 290, null, null, 'center');
                }

                const fileName = 'Laporan_' + now.toLocaleDateString('id-ID').replace(/\//g, '-') + '.pdf';
                doc.save(fileName);
                
                showToast('‚úÖ PDF berhasil diunduh!', 'success');
            } catch (error) {
                console.error('Error PDF:', error);
                alert('‚ùå Error: ' + error.message);
            }
        }

        function formatCurrency(amount) {
            return 'Rp ' + Math.round(amount).toLocaleString('id-ID');
        }
    </script>
</body>
</html>